<!DOCTYPE html>
<html lang="fr">
<head>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/observations.css') }}">
</head>
<body id="popupObservations">
    <h2>{{ titre }}</h2>
    <form action="/observations" method="POST" id="selectAnnee">
        <input type="hidden" name="clicked" value="{{ clicked }}">
        
        <div class="filter-group">
            <label>Département:</label>
            <select name="selectionDepartement" id="selectionDepartement">
                {% for dept in allDepts %}
                <option value="{{ dept }}" {% if dept == selectedDept %}selected{% endif %}>
                    {{ dept }}
                </option>
                {% endfor %}
            </select>
        </div>

        {% if clicked == "evoPoissonsZone" %}
            <label>Poissons :</label>
            <select name="selectionPoisson" id="selectionPoisson">
                <option value="all" {% if selectedPoisson == "all" %}selected{% endif %}>Tous les poissons confondus</option>
                {% for fish in poissonsDispo %}
                <option value="{{ fish }}" {% if fish == selectedPoisson %}selected{% endif %}>
                    {{ fish }}
                </option>
                {% endfor %}
            </select>
        {% endif %}

        <div class="filter-group">
            <label>Année:</label>
            <select name="poissonAnneeSelection" id="poissonAnneeSelection">
                {% for annee in annees %}
                <option value="{{ annee }}" {% if annee == selectedAnnee %}selected{% endif %}>
                    {{ annee }} - {{ annee + 5 }}
                </option>
                {% endfor %}
            </select>
        </div>

        <button type="button" id="validateBtn" class="validate-btn">Valider</button>
    </form>

    <div id="resultsContainer">
        <img src="{{ image }}" alt="Graphique poissons">
        <p id="dateAffichee">{{ dctPoissons }}</p>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        const form = document.getElementById('selectAnnee');
        const validateBtn = document.getElementById('validateBtn');
        const resultsContainer = document.getElementById('resultsContainer');
        const popupContent = document.getElementById('popupContent') || document.body;

        validateBtn.addEventListener('click', () => {
            // Affiche l'indicateur de chargement
            resultsContainer.innerHTML = `
                <div class="loading-indicator">
                    <div class="spinner"></div>
                    <div>Chargement des données...</div>
                </div>
            `;

            // Prépare les données du formulaire
            const formData = new FormData(form);
            let data = {};
            formData.forEach((value, key) => {
                data[key] = value;
            });

            // Envoi fetch POST JSON
            fetch('/observations', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            })
            .then(resp => resp.text())
            .then(html => {
                // Crée un élément temporaire pour parser le HTML
                const temp = document.createElement('div');
                temp.innerHTML = html;
                
                // Récupère le nouveau contenu des résultats
                const newResults = temp.querySelector('#resultsContainer') || 
                                  temp.querySelector('body');
                
                if (newResults) {
                    resultsContainer.innerHTML = newResults.innerHTML;
                }

                // Recharge le script anneeObservation.js si besoin
                const script = document.createElement('script');
                script.src = "/static/javascript/anneeObservation.js";
                script.onload = () => {
                    if (typeof initialiserSelectAnnee === 'function') {
                        initialiserSelectAnnee();
                    }
                };
                document.body.appendChild(script);
            })
            .catch(error => {
                console.error(error);
                resultsContainer.innerHTML = `
                    <div class="error-message">
                        Une erreur est survenue lors du chargement des données.
                    </div>
                `;
            });
        });
    });
    </script>
</body>
</html>