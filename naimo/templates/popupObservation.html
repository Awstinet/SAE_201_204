<!DOCTYPE html>
<html lang="fr">
<head>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/observations.css') }}">
</head>
<body id="popupObservations">
    <h2>{{ titre }}</h2>
    <span>Choisir une année : </span>        
    <form action="/observations" method="POST" id="selectAnnee">
        <input type="hidden" name="clicked" value="{{ clicked }}">

        <select name="selectionDepartement" id="selectionDepartement">
            {% for dept in allDepts %}
            <option value="{{ dept }}" {% if dept == selectedDept %}selected{% endif %}>
                {{ dept }}
            </option>
            {% endfor %}
        </select>
        
        {% if clicked == "evoPoissonsZone" %}
        <select name="selectionPoisson" id="selectionPoisson">
            <option value="all" {% if selectedPoisson == "all" %}selected{% endif %}>Tous les poissons confondus</option>
            {% for fish in poissonsDispo %}
            <option value="{{ fish }}" {% if fish == selectedPoisson %}selected{% endif %}>
                {{ fish }}
            </option>
            {% endfor %}
        </select>
        {% endif %}

        <select name="poissonAnneeSelection" id="poissonAnneeSelection">
            {% for annee in annees %}
            <option value="{{ annee }}" {% if annee == selectedAnnee %}selected{% endif %}>
                {{ annee }} - {{ annee + 5 }}
            </option>
            {% endfor %}
        </select>
    </form>

    <img src="{{ image }}" alt="Graphique poissons">
    <p id="dateAffichee">{{ dctPoissons }}</p>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        const form = document.getElementById('selectAnnee');
        const selects = form.querySelectorAll('select');

        selects.forEach(select => {
            select.addEventListener('change', () => {
                // Prépare les données du formulaire
                const formData = new FormData(form);
                let data = {};
                formData.forEach((value, key) => {
                    data[key] = value;
                });

                // Envoi fetch POST JSON
                fetch('/observations', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                })
                .then(resp => resp.text())
                .then(html => {
                    const popupContent = document.getElementById('popupContent');
                    if (popupContent) {
                        popupContent.innerHTML = html;

                        // Recharge le script anneeObservation.js si besoin
                        const script = document.createElement('script');
                        script.src = "/static/javascript/anneeObservation.js";
                        script.onload = () => {
                            if (typeof initialiserSelectAnnee === 'function') {
                                initialiserSelectAnnee();
                            }
                        };
                        document.body.appendChild(script);
                    }
                })
                .catch(console.error);
            });
        });
    });
    </script>
</body>
</html>
